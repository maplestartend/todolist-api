name: "Pull Request æª¢æŸ¥"

# è§¸ç™¼æ¢ä»¶ï¼šç•¶å»ºç«‹æˆ–æ›´æ–° Pull Request æ™‚
on:
  pull_request:
    branches:
      - main
      - develop
    types: [opened, synchronize, reopened]

# ç’°å¢ƒè®Šæ•¸
env:
  DOTNET_VERSION: "8.0.x"

jobs:
  # PR åŸºæœ¬æª¢æŸ¥
  pr-validation:
    name: "PR é©—è­‰"
    runs-on: ubuntu-latest

    steps:
      - name: "æª¢å‡ºç¨‹å¼ç¢¼"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "æª¢æŸ¥ PR æ¨™é¡Œæ ¼å¼"
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          if [[ ! "$PR_TITLE" =~ ^(feat|fix|docs|style|refactor|perf|test|chore|ci)(\(.+\))?: .+ ]]; then
            echo "âŒ PR æ¨™é¡Œæ ¼å¼ä¸æ­£ç¢º"
            echo "æ­£ç¢ºæ ¼å¼ï¼štype(scope): description"
            echo "ä¾‹å¦‚ï¼šfeat(api): add user authentication"
            exit 1
          else
            echo "âœ… PR æ¨™é¡Œæ ¼å¼æ­£ç¢º"
          fi

      - name: "æª¢æŸ¥ PR æè¿°"
        run: |
          PR_BODY="${{ github.event.pull_request.body }}"
          if [[ -z "$PR_BODY" || ${#PR_BODY} -lt 20 ]]; then
            echo "âŒ PR æè¿°å¤ªçŸ­æˆ–ç‚ºç©º"
            echo "è«‹æä¾›è©³ç´°çš„è®Šæ›´èªªæ˜Ž"
            exit 1
          else
            echo "âœ… PR æè¿°æ ¼å¼æ­£ç¢º"
          fi

  # ç¨‹å¼ç¢¼æª¢æŸ¥
  code-review:
    name: "ç¨‹å¼ç¢¼å¯©æŸ¥"
    runs-on: ubuntu-latest
    needs: pr-validation

    steps:
      - name: "æª¢å‡ºç¨‹å¼ç¢¼"
        uses: actions/checkout@v4

      - name: "è¨­å®š .NET SDK"
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: "é‚„åŽŸå¥—ä»¶"
        run: dotnet restore

      - name: "ç¨‹å¼ç¢¼æ ¼å¼æª¢æŸ¥"
        run: |
          dotnet format --verify-no-changes --verbosity diagnostic
          if [ $? -ne 0 ]; then
            echo "âŒ ç¨‹å¼ç¢¼æ ¼å¼ä¸æ­£ç¢º"
            echo "è«‹åŸ·è¡Œ 'dotnet format' ä¿®æ­£æ ¼å¼"
            exit 1
          else
            echo "âœ… ç¨‹å¼ç¢¼æ ¼å¼æ­£ç¢º"
          fi

      - name: "å»ºæ§‹æª¢æŸ¥"
        run: |
          dotnet build --no-restore --configuration Release
          if [ $? -ne 0 ]; then
            echo "âŒ å»ºæ§‹å¤±æ•—"
            exit 1
          else
            echo "âœ… å»ºæ§‹æˆåŠŸ"
          fi

  # æ¸¬è©¦æª¢æŸ¥
  test-check:
    name: "æ¸¬è©¦æª¢æŸ¥"
    runs-on: ubuntu-latest
    needs: code-review

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test123
          POSTGRES_DB: todolist_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: "æª¢å‡ºç¨‹å¼ç¢¼"
        uses: actions/checkout@v4

      - name: "è¨­å®š .NET SDK"
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: "é‚„åŽŸå¥—ä»¶"
        run: dotnet restore

      - name: "å»ºæ§‹"
        run: dotnet build --no-restore --configuration Release

      - name: "åŸ·è¡Œæ¸¬è©¦"
        run: |
          dotnet test --no-build --configuration Release --logger "console;verbosity=detailed"
          if [ $? -ne 0 ]; then
            echo "âŒ æ¸¬è©¦å¤±æ•—"
            exit 1
          else
            echo "âœ… æ‰€æœ‰æ¸¬è©¦é€šéŽ"
          fi
        env:
          ConnectionStrings__DefaultConnection: "Host=localhost;Database=todolist_test;Username=postgres;Password=test123"

  # è®Šæ›´æª”æ¡ˆåˆ†æž
  changes-analysis:
    name: "è®Šæ›´åˆ†æž"
    runs-on: ubuntu-latest

    steps:
      - name: "æª¢å‡ºç¨‹å¼ç¢¼"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "åˆ†æžè®Šæ›´çš„æª”æ¡ˆ"
        id: changes
        uses: dorny/paths-filter@v2
        with:
          filters: |
            api:
              - '**/*.cs'
              - '**/*.csproj'
              - '**/appsettings*.json'
            docker:
              - 'Dockerfile'
              - 'docker-compose*.yml'
              - '.dockerignore'
            ci:
              - '.github/workflows/**'
            docs:
              - '**/*.md'

      - name: "è®Šæ›´æ‘˜è¦"
        run: |
          echo "ðŸ“‹ è®Šæ›´æ‘˜è¦ï¼š"
          if [ "${{ steps.changes.outputs.api }}" == "true" ]; then
            echo "ðŸ”§ API ç¨‹å¼ç¢¼è®Šæ›´"
          fi
          if [ "${{ steps.changes.outputs.docker }}" == "true" ]; then
            echo "ðŸ³ Docker é…ç½®è®Šæ›´"
          fi
          if [ "${{ steps.changes.outputs.ci }}" == "true" ]; then
            echo "âš¡ CI/CD é…ç½®è®Šæ›´"
          fi
          if [ "${{ steps.changes.outputs.docs }}" == "true" ]; then
            echo "ðŸ“š æ–‡ä»¶è®Šæ›´"
          fi

  # PR ç‹€æ…‹å ±å‘Š
  pr-summary:
    name: "PR ç¸½çµå ±å‘Š"
    runs-on: ubuntu-latest
    needs: [pr-validation, code-review, test-check, changes-analysis]
    if: always()

    steps:
      - name: "ç”Ÿæˆ PR å ±å‘Š"
        run: |
          echo "## ðŸ” Pull Request æª¢æŸ¥å ±å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.pr-validation.result }}" == "success" ]; then
            echo "âœ… **PR é©—è­‰**: é€šéŽ" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **PR é©—è­‰**: å¤±æ•—" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.code-review.result }}" == "success" ]; then
            echo "âœ… **ç¨‹å¼ç¢¼å¯©æŸ¥**: é€šéŽ" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **ç¨‹å¼ç¢¼å¯©æŸ¥**: å¤±æ•—" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.test-check.result }}" == "success" ]; then
            echo "âœ… **æ¸¬è©¦æª¢æŸ¥**: é€šéŽ" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **æ¸¬è©¦æª¢æŸ¥**: å¤±æ•—" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.changes-analysis.result }}" == "success" ]; then
            echo "âœ… **è®Šæ›´åˆ†æž**: å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **è®Šæ›´åˆ†æž**: å¤±æ•—" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ æª¢æŸ¥é …ç›®" >> $GITHUB_STEP_SUMMARY
          echo "- [x] PR æ¨™é¡Œæ ¼å¼æª¢æŸ¥" >> $GITHUB_STEP_SUMMARY
          echo "- [x] PR æè¿°æª¢æŸ¥" >> $GITHUB_STEP_SUMMARY
          echo "- [x] ç¨‹å¼ç¢¼æ ¼å¼æª¢æŸ¥" >> $GITHUB_STEP_SUMMARY
          echo "- [x] å»ºæ§‹æª¢æŸ¥" >> $GITHUB_STEP_SUMMARY
          echo "- [x] å–®å…ƒæ¸¬è©¦æª¢æŸ¥" >> $GITHUB_STEP_SUMMARY
          echo "- [x] è®Šæ›´æª”æ¡ˆåˆ†æž" >> $GITHUB_STEP_SUMMARY
