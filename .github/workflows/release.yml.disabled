name: "è‡ªå‹•åŒ–ç™¼ä½ˆ"

# è§¸ç™¼æ¢ä»¶ï¼šç•¶æ¨é€ tag æ™‚
on:
  push:
    tags:
      - "v*.*.*" # ä¾‹å¦‚ï¼šv1.0.0, v1.2.3

# ç’°å¢ƒè®Šæ•¸
env:
  DOTNET_VERSION: "8.0.x"
  DOCKER_REGISTRY: "ghcr.io"
  IMAGE_NAME: "todolist-api"

jobs:
  # é©—è­‰ç‰ˆæœ¬æ¨™ç±¤
  validate-tag:
    name: "é©—è­‰ç‰ˆæœ¬æ¨™ç±¤"
    runs-on: ubuntu-latest

    outputs:
      version: ${{ steps.version.outputs.version }}
      is-prerelease: ${{ steps.version.outputs.prerelease }}

    steps:
      - name: "æª¢å‡ºç¨‹å¼ç¢¼"
        uses: actions/checkout@v4

      - name: "è§£æç‰ˆæœ¬è™Ÿ"
        id: version
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          VERSION=${TAG_NAME#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # æª¢æŸ¥æ˜¯å¦ç‚ºé ç™¼å¸ƒç‰ˆæœ¬
          if [[ "$VERSION" =~ -[a-zA-Z] ]]; then
            echo "prerelease=true" >> $GITHUB_OUTPUT
            echo "é€™æ˜¯é ç™¼å¸ƒç‰ˆæœ¬: $VERSION"
          else
            echo "prerelease=false" >> $GITHUB_OUTPUT
            echo "é€™æ˜¯æ­£å¼ç‰ˆæœ¬: $VERSION"
          fi

      - name: "é©—è­‰ç‰ˆæœ¬æ ¼å¼"
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+)?$ ]]; then
            echo "âŒ ç‰ˆæœ¬è™Ÿæ ¼å¼ä¸æ­£ç¢º: $VERSION"
            echo "æ­£ç¢ºæ ¼å¼ï¼š1.0.0 æˆ– 1.0.0-beta"
            exit 1
          else
            echo "âœ… ç‰ˆæœ¬è™Ÿæ ¼å¼æ­£ç¢º: $VERSION"
          fi

  # å»ºæ§‹ç™¼ä½ˆç‰ˆæœ¬
  build-release:
    name: "å»ºæ§‹ç™¼ä½ˆç‰ˆæœ¬"
    runs-on: ubuntu-latest
    needs: validate-tag

    steps:
      - name: "æª¢å‡ºç¨‹å¼ç¢¼"
        uses: actions/checkout@v4

      - name: "è¨­å®š .NET SDK"
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: "é‚„åŸå¥—ä»¶"
        run: dotnet restore

      - name: "å»ºæ§‹ç™¼ä½ˆç‰ˆæœ¬"
        run: |
          dotnet build --configuration Release --no-restore \
            -p:Version=${{ needs.validate-tag.outputs.version }} \
            -p:AssemblyVersion=${{ needs.validate-tag.outputs.version }} \
            -p:FileVersion=${{ needs.validate-tag.outputs.version }}

      - name: "åŸ·è¡Œæ¸¬è©¦"
        run: dotnet test --configuration Release --no-build --verbosity normal

      - name: "ç™¼ä½ˆæ‡‰ç”¨ç¨‹å¼"
        run: |
          dotnet publish --configuration Release --no-build \
            --output ./publish \
            -p:Version=${{ needs.validate-tag.outputs.version }}

      - name: "ä¸Šå‚³ç™¼ä½ˆæª”æ¡ˆ"
        uses: actions/upload-artifact@v4
        with:
          name: publish-artifacts
          path: ./publish/
          retention-days: 30

  # å»ºæ§‹ Docker æ˜ åƒæª”
  build-docker-release:
    name: "å»ºæ§‹ç™¼ä½ˆ Docker æ˜ åƒæª”"
    runs-on: ubuntu-latest
    needs: [validate-tag, build-release]

    steps:
      - name: "æª¢å‡ºç¨‹å¼ç¢¼"
        uses: actions/checkout@v4

      - name: "è¨­å®š Docker Buildx"
        uses: docker/setup-buildx-action@v3

      - name: "ç™»å…¥ GitHub Container Registry"
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: "æå–æ˜ åƒæª” metadata"
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: "å»ºæ§‹ä¸¦æ¨é€ Docker æ˜ åƒæª”"
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64
          build-args: |
            VERSION=${{ needs.validate-tag.outputs.version }}

  # ç”Ÿæˆè®Šæ›´æ—¥èªŒ
  generate-changelog:
    name: "ç”Ÿæˆè®Šæ›´æ—¥èªŒ"
    runs-on: ubuntu-latest
    needs: validate-tag

    outputs:
      changelog: ${{ steps.changelog.outputs.changelog }}

    steps:
      - name: "æª¢å‡ºç¨‹å¼ç¢¼"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "ç”Ÿæˆè®Šæ›´æ—¥èªŒ"
        id: changelog
        run: |
          # ç²å–ä¸Šä¸€å€‹ç‰ˆæœ¬æ¨™ç±¤
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          CURRENT_TAG=${GITHUB_REF#refs/tags/}

          echo "å¾ $PREVIOUS_TAG åˆ° $CURRENT_TAG çš„è®Šæ›´ï¼š"

          # ç”Ÿæˆè®Šæ›´æ—¥èªŒ
          if [ -n "$PREVIOUS_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s (%an)" $PREVIOUS_TAG..$CURRENT_TAG)
          else
            CHANGELOG=$(git log --pretty=format:"- %s (%an)")
          fi

          # åˆ†é¡ commit
          echo "## ğŸš€ æ–°åŠŸèƒ½" > changelog.md
          echo "$CHANGELOG" | grep "^- feat" >> changelog.md || echo "ç„¡æ–°åŠŸèƒ½" >> changelog.md
          echo "" >> changelog.md

          echo "## ğŸ› éŒ¯èª¤ä¿®å¾©" >> changelog.md
          echo "$CHANGELOG" | grep "^- fix" >> changelog.md || echo "ç„¡éŒ¯èª¤ä¿®å¾©" >> changelog.md
          echo "" >> changelog.md

          echo "## ğŸ“š æ–‡ä»¶æ›´æ–°" >> changelog.md
          echo "$CHANGELOG" | grep "^- docs" >> changelog.md || echo "ç„¡æ–‡ä»¶æ›´æ–°" >> changelog.md
          echo "" >> changelog.md

          echo "## ğŸ”§ å…¶ä»–è®Šæ›´" >> changelog.md
          echo "$CHANGELOG" | grep -v "^- (feat|fix|docs)" >> changelog.md || echo "ç„¡å…¶ä»–è®Šæ›´" >> changelog.md

          # è¨­å®šè¼¸å‡º
          {
            echo 'changelog<<EOF'
            cat changelog.md
            echo EOF
          } >> $GITHUB_OUTPUT

  # å»ºç«‹ GitHub Release
  create-release:
    name: "å»ºç«‹ GitHub Release"
    runs-on: ubuntu-latest
    needs:
      [validate-tag, build-release, build-docker-release, generate-changelog]

    steps:
      - name: "æª¢å‡ºç¨‹å¼ç¢¼"
        uses: actions/checkout@v4

      - name: "ä¸‹è¼‰ç™¼ä½ˆæª”æ¡ˆ"
        uses: actions/download-artifact@v4
        with:
          name: publish-artifacts
          path: ./publish/

      - name: "å»ºç«‹ç™¼ä½ˆ ZIP æª”"
        run: |
          cd publish
          zip -r ../todolist-api-${{ needs.validate-tag.outputs.version }}.zip .
          cd ..

      - name: "å»ºç«‹ GitHub Release"
        uses: actions/create-release@v1
        id: create_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: TodoList API v${{ needs.validate-tag.outputs.version }}
          body: |
            # ğŸ‰ TodoList API v${{ needs.validate-tag.outputs.version }}

            ## ğŸ“¦ ä¸‹è¼‰

            - **Docker æ˜ åƒæª”**: `ghcr.io/${{ github.repository_owner }}/todolist-api:${{ needs.validate-tag.outputs.version }}`
            - **åŸå§‹ç¢¼**: è«‹ä½¿ç”¨ä¸‹æ–¹çš„ Source code é€£çµ
            - **ç·¨è­¯æª”æ¡ˆ**: todolist-api-${{ needs.validate-tag.outputs.version }}.zip

            ## ğŸš€ éƒ¨ç½²æ–¹å¼

            ### Docker éƒ¨ç½²
            ```bash
            docker run -p 5000:80 ghcr.io/${{ github.repository_owner }}/todolist-api:${{ needs.validate-tag.outputs.version }}
            ```

            ### Docker Compose éƒ¨ç½²
            ```bash
            git clone https://github.com/${{ github.repository }}.git
            cd ${{ github.event.repository.name }}
            docker-compose up -d
            ```

            ## ğŸ“‹ è®Šæ›´å…§å®¹

            ${{ needs.generate-changelog.outputs.changelog }}

            ## ğŸ”— ç›¸é—œé€£çµ

            - [API æ–‡ä»¶](https://github.com/${{ github.repository }}/blob/main/README.md)
            - [Docker Hub](https://ghcr.io/${{ github.repository_owner }}/todolist-api)
            - [å•é¡Œå›å ±](https://github.com/${{ github.repository }}/issues)
          draft: false
          prerelease: ${{ needs.validate-tag.outputs.is-prerelease == 'true' }}

      - name: "ä¸Šå‚³ç™¼ä½ˆæª”æ¡ˆ"
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./todolist-api-${{ needs.validate-tag.outputs.version }}.zip
          asset_name: todolist-api-${{ needs.validate-tag.outputs.version }}.zip
          asset_content_type: application/zip

  # éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ
  deploy-production:
    name: "éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ"
    runs-on: ubuntu-latest
    needs: [validate-tag, create-release]
    if: needs.validate-tag.outputs.is-prerelease == 'false'
    environment: production

    steps:
      - name: "éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ"
        run: |
          echo "ğŸš€ éƒ¨ç½² TodoList API v${{ needs.validate-tag.outputs.version }} åˆ°ç”Ÿç”¢ç’°å¢ƒ"
          echo "Docker æ˜ åƒæª”: ghcr.io/${{ github.repository_owner }}/todolist-api:${{ needs.validate-tag.outputs.version }}"
          # é€™è£¡åŠ å…¥å¯¦éš›çš„éƒ¨ç½²é‚è¼¯

      - name: "å¥åº·æª¢æŸ¥"
        run: |
          echo "ğŸ” åŸ·è¡Œç”Ÿç”¢ç’°å¢ƒå¥åº·æª¢æŸ¥"
          # é€™è£¡åŠ å…¥å¥åº·æª¢æŸ¥é‚è¼¯

      - name: "éƒ¨ç½²é€šçŸ¥"
        run: |
          echo "âœ… TodoList API v${{ needs.validate-tag.outputs.version }} å·²æˆåŠŸéƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ"
